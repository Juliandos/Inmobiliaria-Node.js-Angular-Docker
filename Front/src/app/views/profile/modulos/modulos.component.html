<!-- Header con botones de acción -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2>Gestión de Módulos</h2>
    <p class="text-muted mb-0" *ngIf="!loading">
      Total: {{ getTotalRecords() }} módulos
      <span *ngIf="filterControl.value"> | Filtrados: {{ getFilteredRecords() }}</span>
    </p>
  </div>
  <div class="d-flex gap-2">
    <button 
      mat-raised-button 
      color="accent" 
      (click)="exportToCSV()"
      [disabled]="loading || dataSource.data.length === 0"
      class="d-flex align-items-center">
      <mat-icon class="me-2">download</mat-icon>
      Exportar CSV
    </button>
    <button 
      mat-raised-button 
      color="primary" 
      (click)="toggleCreateForm()"
      [disabled]="loading"
      class="d-flex align-items-center"
      *hasPermission="{ modulo: 'modulos', operacion: 'c' }">
      <mat-icon class="me-2">add</mat-icon>
      {{ showCreateForm ? 'Cancelar' : 'Nuevo Módulo' }}
    </button>
  </div>
</div>

<!-- Loading indicator -->
<div *ngIf="loading" class="text-center mb-4">
  <mat-icon class="spin">refresh</mat-icon>
  Cargando módulos...
</div>

<!-- Formulario de creación -->
<mat-card *ngIf="showCreateForm" class="mb-4">
  <mat-card-header>
    <mat-card-title>Crear Nuevo Módulo</mat-card-title>
  </mat-card-header>
  <mat-card-content class="pt-3">
    <form [formGroup]="createForm" (ngSubmit)="onCreateModulo()">
      <mat-form-field appearance="outline" class="w-100 mb-3">
        <mat-label>Nombre del Módulo</mat-label>
        <input matInput formControlName="nombre" placeholder="Ej: usuarios, propiedades, roles">
        <mat-hint>El nombre del módulo debe ser descriptivo y único</mat-hint>
        <mat-error *ngIf="createForm.get('nombre')?.hasError('required')">
          El nombre es requerido
        </mat-error>
      </mat-form-field>

      <div class="d-flex gap-2">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          [disabled]="createForm.invalid">
          <mat-icon class="me-2">save</mat-icon>
          Crear Módulo
        </button>
        <button 
          mat-button 
          type="button" 
          (click)="toggleCreateForm()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<!-- Formulario de edición -->
<mat-card *ngIf="showEditForm" class="mb-4">
  <mat-card-header>
    <mat-card-title>Editar Módulo</mat-card-title>
  </mat-card-header>
  <mat-card-content class="pt-3">
    <form [formGroup]="editForm" (ngSubmit)="onUpdateModulo()">
      <mat-form-field appearance="outline" class="w-100 mb-3">
        <mat-label>Nombre del Módulo</mat-label>
        <input matInput formControlName="nombre">
        <mat-error *ngIf="editForm.get('nombre')?.hasError('required')">
          El nombre es requerido
        </mat-error>
      </mat-form-field>

      <div class="d-flex gap-2">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          [disabled]="editForm.invalid">
          <mat-icon class="me-2">update</mat-icon>
          Actualizar Módulo
        </button>
        <button 
          mat-button 
          type="button" 
          (click)="cancelEdit()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<!-- Campo de filtro -->
<mat-form-field appearance="outline" class="mb-3 w-100">
  <mat-label>Filtrar módulos</mat-label>
  <input matInput [formControl]="filterControl" placeholder="Buscar por nombre o ID">
  <mat-icon matPrefix>search</mat-icon>
  <button 
    mat-icon-button 
    matSuffix 
    *ngIf="filterControl.value" 
    (click)="clearFilter()"
    matTooltip="Limpiar filtro">
    <mat-icon>close</mat-icon>
  </button>
</mat-form-field>

<!-- Tabla de módulos -->
<div class="mat-elevation-z8">
  <table mat-table [dataSource]="dataSource" matSort class="w-100">

    <!-- ID Column -->
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold">ID</th>
      <td mat-cell *matCellDef="let modulo">{{ modulo.id }}</td>
    </ng-container>

    <!-- Nombre Column -->
    <ng-container matColumnDef="nombre">
      <th mat-header-cell *matHeaderCellDef mat-sort-header class="fw-bold">Nombre</th>
      <td mat-cell *matCellDef="let modulo">
        <div class="d-flex align-items-center">
          <mat-icon class="me-2 text-primary">extension</mat-icon>
          <strong>{{ modulo.nombre }}</strong>
        </div>
      </td>
    </ng-container>

    <!-- Permisos Count Column -->
    <ng-container matColumnDef="permisos_count">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">Permisos</th>
      <td mat-cell *matCellDef="let modulo">
        <span class="badge bg-info">
          {{ getPermisosCount(modulo) }} permisos
        </span>
      </td>
    </ng-container>

    <!-- Acciones Column -->
    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">Acciones</th>
      <td mat-cell *matCellDef="let modulo">
        <div class="d-flex gap-1">
          <button 
            mat-icon-button 
            color="primary" 
            (click)="onEditModulo(modulo)"
            matTooltip="Editar módulo"
            *hasPermission="{ modulo: 'modulos', operacion: 'u' }">
            <mat-icon>edit</mat-icon>
          </button>
          <button 
            mat-icon-button 
            color="warn" 
            (click)="onDeleteModulo(modulo.id)"
            matTooltip="Eliminar módulo"
            [disabled]="getPermisosCount(modulo) > 0"
            *hasPermission="{ modulo: 'modulos', operacion: 'd' }">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <!-- Paginador -->
  <mat-paginator 
    [pageSizeOptions]="[5, 10, 25, 50, 100]"
    [pageSize]="10"
    showFirstLastButtons
    aria-label="Seleccionar página de módulos">
  </mat-paginator>

  <!-- Mensaje cuando no hay datos -->
  <div *ngIf="dataSource.data.length === 0 && !loading" class="text-center p-4">
    <mat-icon class="text-muted" style="font-size: 48px;">extension</mat-icon>
    <p class="text-muted mt-2">No se encontraron módulos</p>
    <button 
      *ngIf="!showCreateForm"
      mat-raised-button 
      color="primary" 
      (click)="toggleCreateForm()">
      <mat-icon class="me-2">add</mat-icon>
      Crear primer módulo
    </button>
  </div>
</div>

<!-- Información adicional -->
<mat-card class="mt-4" *ngIf="dataSource.data.length > 0">
  <mat-card-content>
    <h4 class="mb-3">
      <mat-icon class="me-2">info</mat-icon>
      Información sobre Módulos
    </h4>
    <ul class="mb-0">
      <li>Los módulos representan las diferentes secciones o funcionalidades del sistema</li>
      <li>Cada módulo puede tener múltiples permisos asociados</li>
      <li>No se puede eliminar un módulo que tenga permisos asociados</li>
      <li>Los nombres de módulos deben ser únicos en el sistema</li>
    </ul>
  </mat-card-content>
</mat-card>