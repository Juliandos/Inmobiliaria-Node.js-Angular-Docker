<!-- Header con botón de crear -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Gestión de Propiedades</h2>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="toggleCreateForm()"
    class="d-flex align-items-center">
    <mat-icon class="me-2">add</mat-icon>
    {{ showCreateForm ? 'Cancelar' : 'Nueva Propiedad' }}
  </button>
</div>

<!-- Formulario de creación -->
<mat-card *ngIf="showCreateForm" class="mb-4">
  <mat-card-header>
    <mat-card-title>Crear Nueva Propiedad</mat-card-title>
  </mat-card-header>
  <mat-card-content class="pt-3">
    <form [formGroup]="createForm" (ngSubmit)="onCreatePropiedad()">
      <div class="row">
        <div class="col-md-6 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Título*</mat-label>
            <input matInput formControlName="titulo" placeholder="Casa en venta">
            <mat-error *ngIf="createForm.get('titulo')?.hasError('required')">
              El título es requerido
            </mat-error>
          </mat-form-field>
        </div>
        
        <div class="col-md-6 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Precio</mat-label>
            <input matInput formControlName="precio" type="number" placeholder="250000000">
            <mat-icon matPrefix>attach_money</mat-icon>
          </mat-form-field>
        </div>
        
        <div class="col-12 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Descripción</mat-label>
            <textarea matInput formControlName="descripcion" rows="3" placeholder="Descripción de la propiedad"></textarea>
          </mat-form-field>
        </div>
        
        <div class="col-md-3 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Habitaciones</mat-label>
            <input matInput formControlName="habitaciones" type="number" placeholder="3">
          </mat-form-field>
        </div>
        
        <div class="col-md-3 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Baños</mat-label>
            <input matInput formControlName="banos" type="number" placeholder="2">
          </mat-form-field>
        </div>
        
        <div class="col-md-3 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Parqueadero</mat-label>
            <input matInput formControlName="parqueadero" type="number" placeholder="1">
          </mat-form-field>
        </div>
        
        <div class="col-md-3 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Tipo</mat-label>
            <mat-select formControlName="tipo_id">
              <mat-option value="">Sin tipo</mat-option>
              <mat-option *ngFor="let tipo of tipos" [value]="tipo.id">
                {{ tipo.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        
        <div class="col-md-6 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Usuario</mat-label>
            <mat-select formControlName="usuario_id">
              <mat-option value="">Sin usuario</mat-option>
              <mat-option *ngFor="let usuario of usuarios" [value]="usuario.id">
                {{ usuario.nombre }} {{ usuario.apellido }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      
      <div class="d-flex gap-2">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          [disabled]="createForm.invalid">
          <mat-icon class="me-2">save</mat-icon>
          Crear Propiedad
        </button>
        <button 
          mat-button 
          type="button" 
          (click)="toggleCreateForm()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<!-- Formulario de edición -->
<mat-card *ngIf="showEditForm" class="mb-4">
  <mat-card-header>
    <mat-card-title>Editar Propiedad</mat-card-title>
  </mat-card-header>
  <mat-card-content class="pt-3">
    <form [formGroup]="editForm" (ngSubmit)="onUpdatePropiedad()">
      <div class="row">
        <div class="col-md-6 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Título*</mat-label>
            <input matInput formControlName="titulo">
            <mat-error *ngIf="editForm.get('titulo')?.hasError('required')">
              El título es requerido
            </mat-error>
          </mat-form-field>
        </div>
        
        <div class="col-md-6 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Precio</mat-label>
            <input matInput formControlName="precio" type="number">
            <mat-icon matPrefix>attach_money</mat-icon>
          </mat-form-field>
        </div>
        
        <div class="col-12 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Descripción</mat-label>
            <textarea matInput formControlName="descripcion" rows="3"></textarea>
          </mat-form-field>
        </div>
        
        <div class="col-md-3 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Habitaciones</mat-label>
            <input matInput formControlName="habitaciones" type="number">
          </mat-form-field>
        </div>
        
        <div class="col-md-3 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Baños</mat-label>
            <input matInput formControlName="banos" type="number">
          </mat-form-field>
        </div>
        
        <div class="col-md-3 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Parqueadero</mat-label>
            <input matInput formControlName="parqueadero" type="number">
          </mat-form-field>
        </div>
        
        <div class="col-md-3 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Tipo</mat-label>
            <mat-select formControlName="tipo_id">
              <mat-option value="">Sin tipo</mat-option>
              <mat-option *ngFor="let tipo of tipos" [value]="tipo.id">
                {{ tipo.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        
        <div class="col-md-6 mb-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Usuario</mat-label>
            <mat-select formControlName="usuario_id">
              <mat-option value="">Sin usuario</mat-option>
              <mat-option *ngFor="let usuario of usuarios" [value]="usuario.id">
                {{ usuario.nombre }} {{ usuario.apellido }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      
      <div class="d-flex gap-2">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          [disabled]="editForm.invalid">
          <mat-icon class="me-2">update</mat-icon>
          Actualizar Propiedad
        </button>
        <button 
          mat-button 
          type="button" 
          (click)="cancelEdit()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<!-- Campo de filtro -->
<mat-form-field appearance="outline" class="mb-3 w-100">
  <mat-label>Filtrar propiedades</mat-label>
  <input matInput [formControl]="filterControl" placeholder="Buscar por título, tipo, usuario o ID">
  <mat-icon matPrefix>search</mat-icon>
</mat-form-field>

<!-- Tabla de propiedades -->
<div class="mat-elevation-z8">
  <table mat-table [dataSource]="filteredPropiedades" class="w-100">
    
    <!-- ID Column -->
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">ID</th>
      <td mat-cell *matCellDef="let propiedad">{{ propiedad.id }}</td>
    </ng-container>

    <!-- Título Column -->
    <ng-container matColumnDef="titulo">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">Título</th>
      <td mat-cell *matCellDef="let propiedad">
        <div>
          <strong>{{ propiedad.titulo }}</strong>
          <div *ngIf="propiedad.descripcion" class="text-muted small">
            {{ propiedad.descripcion | slice:0:50 }}{{ propiedad.descripcion.length > 50 ? '...' : '' }}
          </div>
        </div>
      </td>
    </ng-container>

    <!-- Tipo Column -->
    <ng-container matColumnDef="tipo">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">Tipo</th>
      <td mat-cell *matCellDef="let propiedad">
        <span class="badge bg-info">{{ getTipoNameFromPropiedad(propiedad) }}</span>
      </td>
    </ng-container>

    <!-- Precio Column -->
    <ng-container matColumnDef="precio">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">Precio</th>
      <td mat-cell *matCellDef="let propiedad">
        <strong class="text-success">{{ formatPrice(propiedad.precio) }}</strong>
      </td>
    </ng-container>

    <!-- Usuario Column -->
    <ng-container matColumnDef="usuario">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">Usuario</th>
      <td mat-cell *matCellDef="let propiedad">
        <span class="badge bg-secondary">{{ getUsuarioNameFromPropiedad(propiedad) }}</span>
      </td>
    </ng-container>

    <!-- Habitaciones Column -->
    <ng-container matColumnDef="habitaciones">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">Habitaciones</th>
      <td mat-cell *matCellDef="let propiedad">
        <div class="d-flex align-items-center">
          <mat-icon class="me-1 text-muted" style="font-size: 16px;">bed</mat-icon>
          {{ propiedad.habitaciones || 'N/A' }}
          <span *ngIf="propiedad.banos" class="ms-2">
            <mat-icon class="me-1 text-muted" style="font-size: 16px;">bathtub</mat-icon>
            {{ propiedad.banos }}
          </span>
        </div>
      </td>
    </ng-container>

    <!-- Acciones Column -->
    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef class="fw-bold">Acciones</th>
      <td mat-cell *matCellDef="let propiedad">
        <div class="d-flex gap-1">
          <button 
            mat-icon-button 
            color="primary" 
            (click)="onEditPropiedad(propiedad)"
            matTooltip="Editar propiedad">
            <mat-icon>edit</mat-icon>
          </button>
          <button 
            mat-icon-button 
            color="warn" 
            (click)="onDeletePropiedad(propiedad.id)"
            matTooltip="Eliminar propiedad">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <!-- Mensaje cuando no hay datos -->
  <div *ngIf="filteredPropiedades.length === 0" class="text-center p-4">
    <mat-icon class="text-muted" style="font-size: 48px;">home</mat-icon>
    <p class="text-muted mt-2">No se encontraron propiedades</p>
  </div>
</div>